<!DOCTYPE html>
<html>
<head>
  <meta name="google-site-verification" content="JIDFFXy0ZMfWg5ycvT3KUTqhVCj51lg0e65ChQcYP6s" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React로 블럭 채우기 퍼즐 만들기(4) - 블럭 넣기 구현  | KMS&#39;s blog</title>
  <meta name="description" content="프론트엔드 프로그래머를 목표로 기록하는 블로그입니다. 'React로 블럭 채우기 퍼즐 만들기(4) - 블럭 넣기 구현'read this article.">
  <meta property="og:title" content="React로 블럭 채우기 퍼즐 만들기(4) - 블럭 넣기 구현">
  
  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2021-09-12">
  
  <meta property="og:description" content="프론트엔드 프로그래머를 목표로 기록하는 블로그입니다. 'React로 블럭 채우기 퍼즐 만들기(4) - 블럭 넣기 구현'read this article.">
  <meta property="og:url" content="https://kms-97.github.io/project/react/blockgame/react_blockgame4/">
  <meta property="og:site_name" content="KMS&#39;s blog">
  
  <meta property="og:image" content="https://user-images.githubusercontent.com/72490858/132590612-ca232c1c-5832-4e26-8a11-b737490a3378.PNG">
  
  
  <meta property="og:tags" content="React">
  
  <meta property="og:tags" content="javascript">
  
  <meta property="og:tags" content="ToyProject">
  
  <meta property="og:tags" content="Block Puzzle">
  
  <meta property="og:tags" content="Context API">
  
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="canonical" href="https://kms-97.github.io/project/react/blockgame/react_blockgame4/">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/agate.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR&display=swap">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <script src="https://kit.fontawesome.com/20566136db.js" crossorigin="anonymous"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  
  <script type="text/javascript">
  function toggle_visibility(id) {
    var e = document.getElementById(id);
    if (e.className === 'menu')
      e.className = 'menu hidden';
    else
      e.className = 'menu';
  }
  </script>
</head>
<body>
  <div class="navbar">    
    <div class="logo">
      <a href="/">
        <img src="/images/logo.png" height="34px" />
      </a>
    </div>
    <div class="burger">
      <button onclick="toggle_visibility('menu')">
        <i class="fa fa-bars" aria-hidden="true"></i> Menu
      </button>
    </div>
    <div id="menu" class="menu hidden">
      <ul>
        <li><a href="/about">#About</a></li>
        <li><a href="/categories">#Categories</a></li>
        <li><a href="/tags">#Tags</a></li>
        <li><a href="/works">#Works</a></li>       
      </ul>
      <input class="search" id="search-input" type="search" placeholder="Keyword" value="">
    </div>
  </div>
  <div class="container">    

<div class="post">
  <div class="post-title">
    <a href="https://kms-97.github.io/project/react/blockgame/react_blockgame4/">
      <img src="/images/post-title-icon.png" />
      <div class="post-meta">
        <time>Sun, Sep 12, 2021 21:00</time>
        <h1>React로 블럭 채우기 퍼즐 만들기(4) - 블럭 넣기 구현</h1>
      </div>
    </a>
  </div>
  
  <aside>
    <div class="post-toc">
      <span class="title">TOC</span>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#게임판-상호작용">게임판 상호작용</a></li>
    <li><a href="#드래그드롭-이벤트-추가">드래그&amp;드롭 이벤트 추가</a>
      <ul>
        <li><a href="#드래그-이벤트">드래그 이벤트</a></li>
        <li><a href="#드롭-이벤트">드롭 이벤트</a></li>
        <li><a href="#게임판-채우기">게임판 채우기</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </aside>
  
  <section class="post-content">
    <h2 id="게임판-상호작용">게임판 상호작용</h2>
<p>블럭을 드래그&amp;드롭 할 때, 게임판 위에 위치하는지와 어느 칸에 삽입하는지를 알기 위해 게임판의 좌표를 가져와야할 필요가 있다.</p>
<p><code>ObjectList.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx">    ...
    <span style="color:#a6e22e">useEffect</span>(() =&gt; {
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">container</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;top-gameboard-container&#34;</span>)
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">boundary</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">getBoundingClientRect</span>()
            <span style="color:#66d9ef">return</span> (
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">boundary</span>) <span style="color:#75715e">// 확인용
</span><span style="color:#75715e"></span>            )
            }
        )
    ...
</code></pre></div><p>useEffect를 사용하여 DOM이 렌더링되고 난 이후 게임판의 좌표를 <code>getBoundingCilentRect()</code> 통해서 가져오고자 했다.</p>
<p align="center">
　<img src="https://user-images.githubusercontent.com/72490858/132590612-ca232c1c-5832-4e26-8a11-b737490a3378.PNG" width="1000px">
</p>
<p>결과는 에러였는데, 서로 다른 컴포넌트에서 렌더링되어 useEffect로 접근이 불가능한 듯하다. 이를 해결하기 위해서 context를 통한 전역변수로 사용하고자 했는데, 게임판의 좌표 외에 각 격자마다의 좌표, 삽입할 경우의 style 또는 state 변경 등을 생각하면 모두 context로 전달하기에는 너무 복잡해질 것 같았다.<br>
그래서 <code>ObjectList.js</code>와 <code>Gameboard.js</code>를 합쳐 서로의 DOM에 접근할 수 있도록 하기로 했다.</p>
<p><code>App.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">=</span> () =&gt; {
  <span style="color:#66d9ef">return</span> (
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">className</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;top-container&#34;</span>&gt;
      &lt;<span style="color:#f92672">GameDataProvider</span>&gt;
          &lt;<span style="color:#f92672">Gamemode</span>/&gt;
          &lt;<span style="color:#f92672">Scoreboard</span>/&gt;
          &lt;<span style="color:#f92672">Gameboard</span>/&gt;
      &lt;/<span style="color:#f92672">GameDataProvider</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;  
  )
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">App</span>;
</code></pre></div><p><code>Gameboard.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Gameboard</span> <span style="color:#f92672">=</span> () =&gt; {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blockListLength</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#75715e">// 생성할 블럭의 개수
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">makeBlockList</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">length</span>) =&gt; {
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blockList</span> <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
            <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">push</span>(&lt;<span style="color:#f92672">Block</span> <span style="color:#a6e22e">key</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">i</span>}/&gt;)
        }
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">blockList</span>
    }

    <span style="color:#66d9ef">return</span> (
        &lt;<span style="color:#f92672">div</span>&gt;
            &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;block-list&#34;</span> <span style="color:#a6e22e">className</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;alert alert-light rounded-3 border border-primary&#34;</span>&gt;
                {<span style="color:#a6e22e">makeBlockList</span>(<span style="color:#a6e22e">blockListLength</span>)}
            &lt;/<span style="color:#f92672">div</span>&gt;
        &lt;/<span style="color:#f92672">div</span>&gt;
    )
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">Gameboard</span>

...


<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Block</span> <span style="color:#f92672">=</span> () =&gt; {
    
    <span style="color:#66d9ef">return</span> (
        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">className</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;block&#34;</span>&gt;
            &lt;<span style="color:#f92672">DisplayBlock</span>/&gt;
        &lt;/<span style="color:#f92672">div</span>&gt;
    )
}

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DisplayBlock</span> <span style="color:#f92672">=</span> () =&gt; {
    <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">blockState</span>, <span style="color:#a6e22e">setBlockState</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>({
        <span style="color:#a6e22e">blockArray</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()[<span style="color:#e6db74">&#39;blockArray&#39;</span>],
        <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()[<span style="color:#e6db74">&#39;color&#39;</span>],
        <span style="color:#a6e22e">blockRotate</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()[<span style="color:#e6db74">&#39;blockRotate&#39;</span>]
    })

    <span style="color:#66d9ef">return</span> (
        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">className</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;block-container&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span>{{<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`rotate(</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">blockState</span>.<span style="color:#a6e22e">blockRotate</span><span style="color:#e6db74">}</span><span style="color:#e6db74">deg)`</span>}} <span style="color:#a6e22e">onDragStart</span><span style="color:#f92672">=</span>{() =&gt; (<span style="color:#66d9ef">false</span>)} <span style="color:#a6e22e">onMouseDown</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">onmousedown</span>}&gt;
            {
                <span style="color:#a6e22e">blockState</span>.<span style="color:#a6e22e">blockArray</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">line</span>) =&gt; {
                    <span style="color:#66d9ef">return</span>(
                        &lt;<span style="color:#f92672">div</span>&gt;
                            {<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">each</span>) =&gt; {
                                <span style="color:#66d9ef">return</span>(
                                    <span style="color:#a6e22e">each</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">?</span>
                                    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">className</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;block-child fill&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span>{{<span style="color:#a6e22e">backgroundColor</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockState</span>.<span style="color:#a6e22e">color</span>}}&gt;&lt;/<span style="color:#f92672">div</span>&gt;
                                    <span style="color:#f92672">:</span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">className</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;block-child blank&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
                                )
                            })}
                        &lt;/<span style="color:#f92672">div</span>&gt;
                    )
                })
            }
        &lt;/<span style="color:#f92672">div</span>&gt;
    )
}
</code></pre></div><p><code>ObjectUtil.js</code>의 이름을 좀 더 알기 쉽게 <code>BlockUtil.js</code>로 바꾸고, <code>DisplayBlock()</code>함수를 꺼내 컴포넌트로 만들었다. 반복을 위해 Gameboard 컴포넌트에 <code>blockListLength</code> 변수로 형성될 블럭 갯수를 설정하고 return 내에서 map으로 반복하였다.<br>
이 과정에서 꽤 많은 시간이 소모되었는데, 다른 컴포넌트, 여기선 형제 컴포넌트에서 만들어지는 DOM에 접근하기 위해 Portal이나 useRef와 같은 다른 방법들을 찾아봤지만 대부분 기대한 효과가 아니거나 적절하지 못했고, ref 자체를 context로 넘겨주는 방법도 고려했지만 지속적인 상호작용에서는 계속 발생할 렌더링이 그리 적합하지 않다고 생각해 합치는 방향으로 잡았다.<br></p>
<h2 id="드래그드롭-이벤트-추가">드래그&amp;드롭 이벤트 추가</h2>
<h3 id="드래그-이벤트">드래그 이벤트</h3>
<p><code>Gameboard.js &gt; DisplayBlock()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">    <span style="color:#a6e22e">useEffect</span>(() =&gt; {
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">onmousedown</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">event</span>) =&gt; {
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blockContainer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">currentTarget</span>  
            <span style="color:#75715e">// 클릭 시 보드에 맞게 블록 크기 확장
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">childBlockList</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">querySelectorAll</span>(<span style="color:#e6db74">&#34;div.block-child&#34;</span>)
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">squareWidth</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;.square&#39;</span>).<span style="color:#a6e22e">clientWidth</span>
            <span style="color:#a6e22e">childBlockList</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">childBlock</span>) =&gt; {
                <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">squareWidth</span> <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;px&#39;</span>
                <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">squareWidth</span> <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;px&#39;</span>
            })

            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shiftX</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">clientX</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">getBoundingClientRect</span>().<span style="color:#a6e22e">left</span>;
            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shiftY</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">clientY</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">getBoundingClientRect</span>().<span style="color:#a6e22e">top</span>;

            <span style="color:#75715e">// (1) absolute 속성과 zIndex 프로퍼티를 수정해 공이 제일 위에서 움직이기 위한 준비를 합니다.
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;absolute&#39;</span>;
            <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">zIndex</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;

            <span style="color:#75715e">// 현재 위치한 부모에서 body로 직접 이동하여
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// body를 기준으로 위치를 지정합니다.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 유효하지 않은 위치일 경우 원상복귀를 위한 부모 노드 저장
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parentNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">parentNode</span>
            document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">blockContainer</span>);

            <span style="color:#75715e">// 공을 pageX, pageY 좌표 중앙에 위치하게 합니다.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">moveAt</span>(<span style="color:#a6e22e">pageX</span>, <span style="color:#a6e22e">pageY</span>) {
                <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pageX</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">shiftX</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;px&#39;</span>;
                <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pageY</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">shiftY</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;px&#39;</span>;
            }

            <span style="color:#75715e">// 포인터 아래로 공을 이동시킵니다.
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">moveAt</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">pageX</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">pageY</span>);

            <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">onMouseMove</span>(<span style="color:#a6e22e">event</span>) {
                <span style="color:#a6e22e">moveAt</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">pageX</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">pageY</span>);
            }

            <span style="color:#75715e">// (2) mousemove로 공을 움직입니다.
</span><span style="color:#75715e"></span>            document.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;mousemove&#39;</span>, <span style="color:#a6e22e">onMouseMove</span>);

            <span style="color:#75715e">// (3) 공을 드롭하고, 불필요한 핸들러를 제거합니다.
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">onmouseup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
                document.<span style="color:#a6e22e">removeEventListener</span>(<span style="color:#e6db74">&#39;mousemove&#39;</span>, <span style="color:#a6e22e">onMouseMove</span>);
            }
        }
    })
</code></pre></div><p>드래그&amp;드롭 이벤트 구현에 있어서는 <a href="https://ko.javascript.info/mouse-drag-and-drop">모던 JavaScript 튜토리얼</a>의 내용을 많이 참고했다. 코드와 알고리즘이 자세히 설명되어있어 이해하기 쉽고 매우 도움이 되었다. 드래그 시작 시 보드의 크기에 맞게 블럭 확장을 위해 clientWidth로 값을 가져와 변경해주었고, 이동 시 body 태그로 노드를 옮겨 위치를 지정하기 때문에, 이후 적절한 위치에 드롭되지 않을 경우 다시 제자리로 이동하기 위해 부모노드를 변수에 담아두도록 했다.</p>
<h3 id="드롭-이벤트">드롭 이벤트</h3>
<p><code>Gameboard.js &gt; DisplayBlock()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx">        <span style="color:#a6e22e">blockContainer</span>.<span style="color:#a6e22e">onmouseup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
            document.<span style="color:#a6e22e">removeEventListener</span>(<span style="color:#e6db74">&#39;mousemove&#39;</span>, <span style="color:#a6e22e">onMouseMove</span>);

            <span style="color:#75715e">// 블럭이 유효한 위치인지 확인(.sqaure 위에 위치해있는지, 아니면 반환)
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">isValidPosition</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">block</span>) =&gt; {
                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blockList</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">querySelectorAll</span>(<span style="color:#e6db74">&#34;.block-child&#34;</span>)
                <span style="color:#66d9ef">try</span> {
                    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
                        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">childBlock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">item</span>(<span style="color:#a6e22e">i</span>)
                        <span style="color:#75715e">// 색이 채워진 블럭의 위치만 판정
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>[<span style="color:#e6db74">&#34;background-color&#34;</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;transparent&#39;</span>) <span style="color:#66d9ef">continue</span>

                        <span style="color:#75715e">// 드롭된 위치를 기준으로 밑에 위치한 element 찾기
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">const</span> {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">presentX</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">presentY</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">getBoundingClientRect</span>()
                        <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">hidden</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
                        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">objectBelow</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">elementFromPoint</span>(<span style="color:#a6e22e">presentX</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">squareWidth</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">presentY</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">squareWidth</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)
                        <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">hidden</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>

                        <span style="color:#75715e">// 요소 중 하나라도 유효하지 않은 위치에 있으면 원위치
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">objectBelow</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">objectBelow</span>.<span style="color:#a6e22e">className</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;square&#39;</span>))) {
                            <span style="color:#66d9ef">throw</span>(<span style="color:#e6db74">&#39;not valid position&#39;</span>)
                        }
                    }
                } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span>) {
                    <span style="color:#a6e22e">parentNode</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">block</span>)
                    <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;relative&#34;</span>
                    <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
                    <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
                    <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">childBlock</span>) =&gt; {
                        <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;40px&#39;</span>
                        <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;40px&#39;</span>
                    })
                }
            }
            
            <span style="color:#a6e22e">isValidPosition</span>(<span style="color:#a6e22e">blockContainer</span>)
        };
</code></pre></div><p><code>Displayblock()</code>함수 내부의 <code>onmouseup</code> 속성 내부에 적절한 위치에 드랍되었는지를 확인하는 <code>isValidPosition()</code>함수를 추가하였다. 옮겨진 블럭에서 <code>elementFromPoint()</code>함수로 가져온 하위 element가 게임판의 square가 아니거나 없을 경우, 그리고 칸이 이미 채워진 경우 drag 이벤트가 시작되기 전 부모 노드로 돌아오도록 했다. 
<br></p>
<p align="center">s
　<img src="https://user-images.githubusercontent.com/72490858/133054222-4a2892d0-8c15-4d88-8cd2-de97ec9052be.gif" width="600px">
</p>
<h3 id="게임판-채우기">게임판 채우기</h3>
<p>이제 블럭이 유효한 위치에서 드랍되면 아래의 게임판의 칸을 채우고 블럭은 사라져야한다. 그 뒤, 새로운 블럭이 생성되게 해준다<br></p>
<p><code>Gameboard.js &gt; DisplayBlock()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">blockState</span>, <span style="color:#a6e22e">setBlockState</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>({
    <span style="color:#a6e22e">blockArray</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()[<span style="color:#e6db74">&#39;blockArray&#39;</span>],
    <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()[<span style="color:#e6db74">&#39;color&#39;</span>],
    <span style="color:#a6e22e">blockRotate</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()[<span style="color:#e6db74">&#39;blockRotate&#39;</span>]
})
...

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">isValidPosition</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">block</span>) =&gt; {
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blockList</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">querySelectorAll</span>(<span style="color:#e6db74">&#34;.block-child&#34;</span>)
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">targetSqaure</span> <span style="color:#f92672">=</span> []
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blockColor</span> <span style="color:#f92672">=</span> []
            <span style="color:#66d9ef">try</span> {
                <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
                    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">childBlock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">item</span>(<span style="color:#a6e22e">i</span>)
                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>[<span style="color:#e6db74">&#34;background-color&#34;</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;transparent&#39;</span>) <span style="color:#66d9ef">continue</span>
                    <span style="color:#a6e22e">blockColor</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>[<span style="color:#e6db74">&#34;background-color&#34;</span>])

                    <span style="color:#66d9ef">const</span> {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">presentX</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">presentY</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">getBoundingClientRect</span>()
                    <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">hidden</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
                    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">objectBelow</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">elementFromPoint</span>(<span style="color:#a6e22e">presentX</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">squareWidth</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">presentY</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">squareWidth</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)
                    <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">hidden</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>

                    <span style="color:#75715e">// 요소 중 하나라도 유효하지 않은 위치에 있으면 원위치
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">objectBelow</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">objectBelow</span>.<span style="color:#a6e22e">className</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;square&#39;</span>))) {
                        <span style="color:#66d9ef">return</span>
                    }
                    <span style="color:#a6e22e">targetSqaure</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">objectBelow</span>)
                }

                <span style="color:#a6e22e">targetSqaure</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">square</span>) =&gt; {
                    <span style="color:#a6e22e">square</span>.<span style="color:#a6e22e">className</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`square </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">blockColor</span>[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
                })

                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newState</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">blockUtil</span>.<span style="color:#a6e22e">makeBlock</span>()
                <span style="color:#a6e22e">setBlockState</span>({...<span style="color:#a6e22e">blockState</span>, <span style="color:#a6e22e">blockArray</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">newState</span>.<span style="color:#a6e22e">blockArray</span>, <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">newState</span>.<span style="color:#a6e22e">color</span>, <span style="color:#a6e22e">blockRotate</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">newState</span>.<span style="color:#a6e22e">blockRotate</span>})
                
            } <span style="color:#66d9ef">finally</span> {
                <span style="color:#a6e22e">parentNode</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">block</span>)
                <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;relative&#34;</span>
                <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
                <span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
                <span style="color:#a6e22e">blockList</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">childBlock</span>) =&gt; {
                    <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;40px&#39;</span>
                    <span style="color:#a6e22e">childBlock</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;40px&#39;</span>
                })
            }
        }
        
        <span style="color:#a6e22e">isValidPosition</span>(<span style="color:#a6e22e">blockContainer</span>)
    };
</code></pre></div><p>렌더링을 유발시키기 위해 state로 만들어줄 블럭 상태를 관리하기로 했다. <code>blockUtil.js</code>에서 형태 리스트, 색상, 회전을 만들어주는 <code>makeBlock()</code> 함수를 가져와 state에 담았다.
<code>isValidPosition()</code>를 수정하여 <code>targetSquare</code> 변수에 <code>elementFromPoint()</code> 함수로 가져온 게임판의 square element를 담은 뒤, 블럭의 색과 동일하게 class를 추가해주었다.<br>
이전에는 유효하지 않은 위치에서는 error를 반환하도록 했는데, 지금은 유효하지 않은 위치와 블럭이 새로 만들어지는 경우 모두 원래의 위치에 표시해야하기 때문에 에러처리를 따로 하지 않고 finally로 받아주었다.</p>
<p><code>Gameboard.css</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">.<span style="color:#a6e22e">gray</span> {<span style="color:#66d9ef">background-color</span>: <span style="color:#66d9ef">gray</span>;}
.<span style="color:#a6e22e">blue</span> {<span style="color:#66d9ef">background-color</span>: <span style="color:#66d9ef">blue</span>;}
.<span style="color:#a6e22e">red</span> {<span style="color:#66d9ef">background-color</span>: <span style="color:#66d9ef">red</span>;}
.<span style="color:#a6e22e">purple</span> {<span style="color:#66d9ef">background-color</span>: <span style="color:#66d9ef">purple</span>;}
.<span style="color:#a6e22e">yellowgreen</span> {<span style="color:#66d9ef">background-color</span>: <span style="color:#66d9ef">yellowgreen</span>;} 
</code></pre></div><p>class를 통해서 채워진 칸의 색을 다루니 css에도 클래스별로 추가해주었다.
<br></p>
<p align="center">s
　<img src="https://user-images.githubusercontent.com/72490858/133065948-9cfe534b-9644-4a7e-94e7-e52d20e4adb4.gif" width="600px">
</p>
  </section>
  
  
  <div class="post-meta-code">
    
    <div class="desc">
      
      <div class="desc">
        <span class="fixed-desc">_Categories</span>
        
        
        <a href="https://kms-97.github.io//categories/project">#project</a>
        
      </div>
      
      <div class="desc">
        <span class="fixed-desc">_Tags</span>
        
        
        <a href="https://kms-97.github.io/tags/react">#React</a>
        
        <a href="https://kms-97.github.io/tags/javascript">#javascript</a>
        
        <a href="https://kms-97.github.io/tags/toyproject">#ToyProject</a>
        
        <a href="https://kms-97.github.io/tags/block-puzzle">#Block Puzzle</a>
        
        <a href="https://kms-97.github.io/tags/context-api">#Context API</a>
        
        
      </div>
    </div>
  </div>  
  
  <div class="post-comment">    
        
  </div>
  
  
    
  </div>
  
</div>
</div>

<div class="go-top">
  <a href="#" class="go-top-button">
    <i class="fa fa-angle-double-up"></i>
    <span>Top</span>
  </a>
</div>
<footer class="footer">
  <div class="social">
    <a href="https://github.com/kms-97"><i class="fa fa-github"></i></a>
    <a href="mailto:msg016@naver.com"><i class="fa fa-envelope"></i></a>
  </div>
  <div class="copyright">
  COPYRIGHT &copy; <a href="https://kms-97.github.io/about">Kim min-su.</a> ALL RIGHTS RESERVED. </br>
  Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️ / 
  <a href="https://github.com/lubang/hugo-hello-programmer-theme" rel="noopener" target="_blank">Hello Programmer Theme</a>
  </div>
</footer>
</body>
</html>

